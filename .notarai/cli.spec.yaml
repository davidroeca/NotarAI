schema_version: '0.4'

intent: >
  A CLI tool that validates NotarAI spec files against the JSON Schema
  and integrates with Claude Code via hooks so specs are automatically
  validated when written or edited. Distributed as a single static binary
  with no runtime dependencies, configured with a single `notarai init`
  command.

behaviors:
  - name: validate_single_file
    given: 'a path to a .spec.yaml file'
    then: 'validates it against the schema, prints PASS or FAIL with errors, exits 0 or 1'

  - name: validate_directory
    given: 'a path to a directory (or no args, defaulting to .notarai/)'
    then: 'recursively finds all .spec.yaml files, validates each; exits 1 if any fail or if no .spec.yaml files are found'

  - name: hook_validate_spec_file
    given: 'PostToolUse JSON on stdin with a file_path matching .notarai/**/*.spec.yaml'
    then: 'reads the file from disk, validates it, exits 1 with errors on stderr if invalid'

  - name: hook_ignore_non_spec
    given: 'PostToolUse JSON on stdin with a file_path that is not a spec file'
    then: 'exits 0 silently without validation'

  - name: hook_graceful_on_bad_input
    given: 'invalid JSON on stdin or a missing file'
    then: 'exits 0 silently without error'

  - name: init_fresh
    given: 'no existing .claude/settings.json'
    then: 'creates .claude/settings.json with the PostToolUse validation hook (command: notarai hook validate), copies notarai-reconcile.md and notarai-bootstrap.md to .claude/commands/, copies notarai.spec.json to .claude/notarai.spec.json, and creates CLAUDE.md with the bundled NotarAI context section (which @-imports the schema)'

  - name: validate_warns_stale_schema
    given: 'notarai validate runs and .claude/notarai.spec.json exists but its $id differs from the bundled schema'
    then: 'prints a warning telling the user to run `notarai init` to update; validation continues normally'

  - name: init_idempotent
    given: "notarai init has already been run, all commands are already installed, and CLAUDE.md already contains a '## NotarAI' section"
    then: 'detects existing hook, commands, and CLAUDE.md context, reports already configured; always refreshes .claude/notarai.spec.json (unconditional overwrite keeps schema current)'

  - name: bootstrap_command_setup
    given: 'notarai init runs and .claude/commands/notarai-bootstrap.md does not exist'
    then: 'copies commands/notarai-bootstrap.md to .claude/commands/notarai-bootstrap.md'

  - name: claude_context_setup
    given: "notarai init runs and the target project's CLAUDE.md does not contain a '## NotarAI' section"
    then: 'appends (or creates) CLAUDE.md with the bundled templates/claude-context.md content'

  - name: init_claude_md_drift_warning
    given: "notarai init runs and CLAUDE.md contains a '## NotarAI' section that differs from the bundled template"
    then: 'prints a warning suggesting manual review or delete-and-reinit; does not overwrite'

constraints:
  - 'Exit codes: 0 for success/no-op, 1 for validation failure or errors'
  - 'CLI uses clap 4.x derive API for argument parsing and help generation'
  - 'The jsonschema validator is compiled once at process init via OnceLock (not per call); runtime schema reads (e.g. freshness checks) are permitted'
  - 'All bundled assets (schema, templates, commands) are embedded at compile time via include_str!'

invariants:
  - 'A valid spec file must never be reported as FAIL'
  - 'An invalid spec file must never be reported as PASS'
  - 'The hook must never block non-spec file writes (must exit 0)'

decisions:
  - date: '2026-02-20'
    choice: 'Reconcile command named notarai-reconcile.md'
    rationale: "Avoids colliding with a user's own /reconcile command"
  - date: '2026-02-23'
    choice: 'Rust over Node.js/TypeScript for the CLI'
    rationale: 'Single static binary with no runtime dependencies enables cross-platform distribution via direct download instead of requiring Node.js; project has not been released yet so this is a clean replacement'
  - date: '2026-02-23'
    choice: 'clap 4.x derive API for CLI parsing'
    rationale: 'Replaces raw process.argv; clap provides structured subcommands, auto-generated help text, and typed argument parsing with minimal boilerplate'
  - date: '2026-02-23'
    choice: 'include_str! for bundled assets instead of runtime file reads'
    rationale: 'Embeds schema, templates, and command files at compile time so the binary is fully self-contained with no adjacent file dependencies'
  - date: '2026-02-23'
    choice: 'assert_cmd + tempfile for integration tests'
    rationale: 'assert_cmd runs the compiled binary as a subprocess matching real usage; tempfile provides isolated directories for init tests'

artifacts:
  code:
    - path: 'src/main.rs'
      role: 'CLI entry point — clap definition and command dispatch'
    - path: 'src/commands/*.rs'
      role: 'Command implementations (validate, init, hook_validate)'
    - path: 'src/core/*.rs'
      role: 'Core library (schema embedding, YAML parsing, jsonschema validation)'
  configs:
    - path: 'Cargo.toml'
      role: 'Rust package manifest — dependencies, build metadata, and binary target'
    - path: 'notarai.spec.json'
      role: 'JSON Schema that spec files are validated against'
    - path: 'commands/notarai-reconcile.md'
      role: 'Bundled Claude Code slash command copied by init'
    - path: 'commands/notarai-bootstrap.md'
      role: 'Bundled Claude Code slash command for bootstrap interview, copied by init'
    - path: 'templates/claude-context.md'
      role: 'Bundled CLAUDE.md section template written by notarai init to target projects'
  tests:
    - path: 'tests/**/*.rs'
      role: 'Integration tests (assert_cmd CLI tests, tempdir-based init tests)'
