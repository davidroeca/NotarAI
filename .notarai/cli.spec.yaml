schema_version: '0.5'

intent: >
  A CLI tool that validates NotarAI spec files against the JSON Schema
  and integrates with Claude Code via hooks so specs are automatically
  validated when written or edited. Distributed as a single static binary
  with no runtime dependencies, configured with a single `notarai init`
  command.

behaviors:
  - name: validate_single_file
    given: 'a path to a .spec.yaml file'
    then: 'validates it against the schema, prints PASS or FAIL with errors, exits 0 or 1'

  - name: validate_directory
    given: 'a path to a directory (or no args, defaulting to .notarai/)'
    then: 'recursively finds all .spec.yaml files, validates each; exits 1 if any fail; exits 0 with a stderr warning if no .spec.yaml files are found'

  - name: hook_validate_spec_file
    given: 'PostToolUse JSON on stdin with a file_path matching .notarai/**/*.spec.yaml'
    then: 'reads the file from disk, validates it, exits 1 with errors on stderr if invalid'

  - name: hook_ignore_non_spec
    given: 'PostToolUse JSON on stdin with a file_path that is not a spec file'
    then: 'exits 0 silently without validation'

  - name: hook_graceful_on_bad_input
    given: 'invalid JSON on stdin or a missing file'
    then: 'exits 0 silently without error'

  - name: init_fresh
    given: 'no existing .claude/settings.json'
    then: >
      creates .claude/settings.json with the PostToolUse validation hook (command: notarai
      hook validate); copies notarai-reconcile.md and notarai-bootstrap.md to
      .claude/commands/ (always overwriting); copies notarai.spec.json to
      .notarai/notarai.spec.json; writes .notarai/README.md from the bundled template with
      the current CLI version injected; creates or updates CLAUDE.md with the NotarAI section
      (@.notarai/README.md and @.notarai/notarai.spec.json); appends .notarai/.cache/ to
      .gitignore; writes .mcp.json registering notarai mcp as a local MCP server

  - name: validate_warns_stale_schema
    given: 'notarai validate runs and .notarai/notarai.spec.json exists but its $id differs from the bundled schema'
    then: 'prints a warning telling the user to run `notarai init` to update; validation continues normally'

  - name: init_idempotent
    given: 'notarai init has already been run'
    then: >
      detects existing hook and MCP entry and reports already configured; always overwrites
      .claude/commands/ (no existence check); always overwrites .notarai/notarai.spec.json and
      .notarai/README.md; replaces the ## NotarAI section in CLAUDE.md with the current
      template content; idempotently checks .gitignore and .mcp.json

  - name: init_replace_claude_section
    given: "CLAUDE.md already contains a '## NotarAI' heading"
    then: 'replaces the content between ## NotarAI and the next ## heading (or EOF) with the current template; does not skip or warn'

  - name: schema_bump
    given: 'notarai schema-bump is invoked in a project with an older schema version'
    then: >
      detects the old version from .notarai/notarai.spec.json, overwrites it with the bundled
      schema, updates the schema_version field in all .notarai/*.spec.yaml files, validates all
      updated specs, and prints a summary; exits 0 on success, 1 on validation failure

  - name: cache_status
    given: 'notarai cache status is invoked'
    then: 'prints the DB file path, the number of cached entries, and the newest entry timestamp; creates an empty DB if none exists'

  - name: cache_clear
    given: 'notarai cache clear is invoked'
    then: 'deletes .notarai/.cache/notarai.db and exits 0; no-op if the file does not exist'

  - name: mcp_cache_filtering
    given: 'get_spec_diff is called with bypass_cache unset or false'
    then: 'files whose BLAKE3 hash matches the cache are listed in the skipped field and excluded from the diff; a cold or absent cache diffs all governed files as a safe fallback'

  - name: mcp_spec_aware_splitting
    given: 'get_spec_diff is called and the diff includes .notarai/*.spec.yaml files'
    then: 'spec files are returned in a separate spec_changes field with full file content (not diff hunks); the system spec is always included in system_spec when any spec changed (with full content if it did not change, or just the path reference if it appears in spec_changes); the diff field contains only non-spec artifact diffs'

  - name: mcp_server
    given: 'notarai mcp is invoked and JSON-RPC 2.0 messages are sent on stdin'
    then: 'responds to initialize with serverInfo and 5 tool definitions (list_affected_specs, get_spec_diff, get_changed_artifacts, mark_reconciled, clear_cache); dispatches tools/call to the appropriate implementation; exits 0 on stdin EOF; get_spec_diff accepts an optional exclude_patterns array of glob strings passed as git :(exclude) pathspecs to suppress noisy files from the diff output; cache-filtering semantics are described by the mcp_cache_filtering behavior; spec-aware splitting semantics are described by the mcp_spec_aware_splitting behavior'

constraints:
  - 'Exit codes: 0 for success/no-op, 1 for validation failure or errors'
  - 'CLI uses clap 4.x derive API for argument parsing and help generation'
  - 'The jsonschema validator is compiled once at process init via OnceLock (not per call); runtime schema reads (e.g. freshness checks) are permitted'
  - 'All bundled assets (schema, templates, commands) are embedded at compile time via include_str!'
  - 'The crate README should contain valid links'
  - 'If certain files are linked in the crate README, they must be bundled with the crate'

invariants:
  - 'A valid spec file must never be reported as FAIL'
  - 'An invalid spec file must never be reported as PASS'
  - 'The hook must never block non-spec file writes (must exit 0)'

decisions:
  - date: '2026-02-20'
    choice: 'Reconcile command named notarai-reconcile.md'
    rationale: "Avoids colliding with a user's own /reconcile command"
  - date: '2026-02-23'
    choice: 'Rust over Node.js/TypeScript for the CLI'
    rationale: 'Single static binary with no runtime dependencies enables cross-platform distribution via direct download instead of requiring Node.js; project has not been released yet so this is a clean replacement'
  - date: '2026-02-23'
    choice: 'clap 4.x derive API for CLI parsing'
    rationale: 'Replaces raw process.argv; clap provides structured subcommands, auto-generated help text, and typed argument parsing with minimal boilerplate'
  - date: '2026-02-23'
    choice: 'include_str! for bundled assets instead of runtime file reads'
    rationale: 'Embeds schema, templates, and command files at compile time so the binary is fully self-contained with no adjacent file dependencies'
  - date: '2026-02-23'
    choice: 'assert_cmd + tempfile for integration tests'
    rationale: 'assert_cmd runs the compiled binary as a subprocess matching real usage; tempfile provides isolated directories for init tests'
  - date: '2026-02-24'
    choice: 'BLAKE3+SQLite hash cache for reconciliation context reduction'
    rationale: 'Hashing governed files and storing results in a local SQLite DB (.notarai/.cache/notarai.db) lets the reconcile command skip doc artifacts that have not changed since the last run, keeping context window usage proportional to actual change volume rather than the full repo'
  - date: '2026-02-24'
    choice: 'Synchronous JSON-RPC 2.0 over stdio for the MCP server (no tokio)'
    rationale: 'The MCP stdio transport is a simple request/response loop -- no async I/O is needed. Synchronous BufRead line-by-line is sufficient and avoids pulling in a tokio runtime'
  - date: '2026-02-24'
    choice: 'rusqlite bundled feature for SQLite'
    rationale: 'Compiles SQLite from source as part of the crate, keeping the binary fully self-contained without requiring a system libsqlite3'
  - date: '2026-02-25'
    choice: 'get_spec_diff filters governed files via hash cache before diffing'
    rationale: 'Files already reconciled (per mark_reconciled) are skipped; only files whose on-disk hash differs from the cache are passed to git diff, making response size proportional to what actually changed since the last reconcile run'
  - date: '2026-02-25'
    choice: 'clear_cache added as a 5th MCP tool alongside bypass_cache on get_spec_diff'
    rationale: 'Cache clearing was CLI-only; exposing it via MCP lets the reconcile command reset state without dropping to the shell; bypass_cache provides a per-call escape hatch without destroying the cache'
  - date: '2026-02-26'
    choice: 'Remove cache update and cache changed CLI subcommands'
    rationale: 'These subcommands were only used to seed the MCP cache from the CLI, but the correct way to seed the cache is via mark_reconciled (which uses relative paths as keys, matching how get_spec_diff queries it). The CLI subcommands used absolute paths as keys, creating a separate namespace. Removing them eliminates the confusion and reduces CLI surface.'
  - date: '2026-02-26'
    choice: 'init always overwrites .claude/commands/ and replaces the CLAUDE.md NotarAI section'
    rationale: 'Previous behavior skipped existing commands and warned on CLAUDE.md drift, requiring manual intervention to keep installed commands in sync with the bundled version. Always overwriting and always replacing makes init idempotent without user involvement -- the section is small and always correct after a run.'
  - date: '2026-02-26'
    choice: 'Move schema copy from .claude/notarai.spec.json to .notarai/notarai.spec.json'
    rationale: '.notarai/ is the natural home for NotarAI config; the old .claude/ path mixed project config with Claude-specific settings. The new location is more predictable and survives .claude/ resets. schema-bump also writes to .notarai/notarai.spec.json for consistency.'

artifacts:
  code:
    - path: 'src/main.rs'
      role: 'CLI entry point -- clap definition and command dispatch'
    - path: 'src/commands/*.rs'
      role: 'Command implementations (validate, init, hook_validate, cache, mcp, schema_bump)'
    - path: 'src/core/*.rs'
      role: 'Core library (schema embedding, YAML parsing, jsonschema validation, hash cache, MCP tool implementations)'
  configs:
    - path: 'Cargo.toml'
      role: 'Rust package manifest -- dependencies, build metadata, and binary target'
    - path: 'notarai.spec.json'
      role: 'JSON Schema that spec files are validated against'
    - path: 'commands/notarai-reconcile.md'
      role: 'Bundled Claude Code slash command copied by init'
    - path: 'commands/notarai-bootstrap.md'
      role: 'Bundled Claude Code slash command for bootstrap interview, copied by init'
    - path: 'templates/notarai-readme.md'
      role: 'Bundled .notarai/README.md template written by notarai init to target projects'
  tests:
    - path: 'tests/**/*.rs'
      role: 'Integration tests (assert_cmd CLI tests, tempdir-based init tests)'
