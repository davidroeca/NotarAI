schema_version: '0.4'

intent: >
  A CLI tool that validates NotarAI spec files against the JSON Schema
  and integrates with Claude Code via hooks so specs are automatically
  validated when written or edited. Distributed as a single static binary
  with no runtime dependencies, configured with a single `notarai init`
  command.

behaviors:
  - name: validate_single_file
    given: 'a path to a .spec.yaml file'
    then: 'validates it against the schema, prints PASS or FAIL with errors, exits 0 or 1'

  - name: validate_directory
    given: 'a path to a directory (or no args, defaulting to .notarai/)'
    then: 'recursively finds all .spec.yaml files, validates each; exits 1 if any fail; exits 0 with a stderr warning if no .spec.yaml files are found'

  - name: hook_validate_spec_file
    given: 'PostToolUse JSON on stdin with a file_path matching .notarai/**/*.spec.yaml'
    then: 'reads the file from disk, validates it, exits 1 with errors on stderr if invalid'

  - name: hook_ignore_non_spec
    given: 'PostToolUse JSON on stdin with a file_path that is not a spec file'
    then: 'exits 0 silently without validation'

  - name: hook_graceful_on_bad_input
    given: 'invalid JSON on stdin or a missing file'
    then: 'exits 0 silently without error'

  - name: init_fresh
    given: 'no existing .claude/settings.json'
    then: 'creates .claude/settings.json with the PostToolUse validation hook (command: notarai hook validate), copies notarai-reconcile.md and notarai-bootstrap.md to .claude/commands/, copies notarai.spec.json to .claude/notarai.spec.json, creates CLAUDE.md with the bundled NotarAI context section (which @-imports the schema), appends .notarai/.cache/ to .gitignore, and writes .mcp.json (project root) registering notarai mcp as a local MCP server'

  - name: validate_warns_stale_schema
    given: 'notarai validate runs and .claude/notarai.spec.json exists but its $id differs from the bundled schema'
    then: 'prints a warning telling the user to run `notarai init` to update; validation continues normally'

  - name: init_idempotent
    given: "notarai init has already been run, all commands are already installed, and CLAUDE.md already contains a '## NotarAI' section"
    then: 'detects existing hook, commands, and CLAUDE.md context, reports already configured; always refreshes .claude/notarai.spec.json (unconditional overwrite keeps schema current); idempotently checks .gitignore for .notarai/.cache/ and .mcp.json (project root) for the notarai MCP server entry'

  - name: bootstrap_command_setup
    given: 'notarai init runs and .claude/commands/notarai-bootstrap.md does not exist'
    then: 'copies commands/notarai-bootstrap.md to .claude/commands/notarai-bootstrap.md'

  - name: claude_context_setup
    given: "notarai init runs and the target project's CLAUDE.md does not contain a '## NotarAI' section"
    then: 'appends (or creates) CLAUDE.md with the bundled templates/claude-context.md content'

  - name: init_claude_md_drift_warning
    given: "notarai init runs and CLAUDE.md contains a '## NotarAI' section that differs from the bundled template"
    then: 'prints a warning suggesting manual review or delete-and-reinit; does not overwrite'

  - name: cache_update
    given: 'one or more file paths as arguments (or one path per line on stdin if no args given)'
    then: 'computes a BLAKE3 hash for each existing file and upserts it into .notarai/.cache/notarai.db; prints the count of files cached'

  - name: cache_changed
    given: 'one or more file paths as arguments (or one path per line on stdin if no args given)'
    then: 'prints only the paths whose content has changed since the last cache update, or that are absent from the cache; always exits 0 (empty output means nothing changed)'

  - name: cache_status
    given: 'notarai cache status is invoked'
    then: 'prints the DB file path and the number of cached entries; creates an empty DB if none exists'

  - name: cache_clear
    given: 'notarai cache clear is invoked'
    then: 'deletes .notarai/.cache/notarai.db and exits 0; no-op if the file does not exist'

  - name: mcp_server
    given: 'notarai mcp is invoked and JSON-RPC 2.0 messages are sent on stdin'
    then: 'responds to initialize with serverInfo and 4 tool definitions (list_affected_specs, get_spec_diff, get_changed_artifacts, mark_reconciled); dispatches tools/call to the appropriate implementation; exits 0 on stdin EOF; get_spec_diff accepts an optional exclude_patterns array of glob strings passed as git :(exclude) pathspecs to suppress noisy files from the diff output'

constraints:
  - 'Exit codes: 0 for success/no-op, 1 for validation failure or errors'
  - 'CLI uses clap 4.x derive API for argument parsing and help generation'
  - 'The jsonschema validator is compiled once at process init via OnceLock (not per call); runtime schema reads (e.g. freshness checks) are permitted'
  - 'All bundled assets (schema, templates, commands) are embedded at compile time via include_str!'

invariants:
  - 'A valid spec file must never be reported as FAIL'
  - 'An invalid spec file must never be reported as PASS'
  - 'The hook must never block non-spec file writes (must exit 0)'

decisions:
  - date: '2026-02-20'
    choice: 'Reconcile command named notarai-reconcile.md'
    rationale: "Avoids colliding with a user's own /reconcile command"
  - date: '2026-02-23'
    choice: 'Rust over Node.js/TypeScript for the CLI'
    rationale: 'Single static binary with no runtime dependencies enables cross-platform distribution via direct download instead of requiring Node.js; project has not been released yet so this is a clean replacement'
  - date: '2026-02-23'
    choice: 'clap 4.x derive API for CLI parsing'
    rationale: 'Replaces raw process.argv; clap provides structured subcommands, auto-generated help text, and typed argument parsing with minimal boilerplate'
  - date: '2026-02-23'
    choice: 'include_str! for bundled assets instead of runtime file reads'
    rationale: 'Embeds schema, templates, and command files at compile time so the binary is fully self-contained with no adjacent file dependencies'
  - date: '2026-02-23'
    choice: 'assert_cmd + tempfile for integration tests'
    rationale: 'assert_cmd runs the compiled binary as a subprocess matching real usage; tempfile provides isolated directories for init tests'
  - date: '2026-02-24'
    choice: 'BLAKE3+SQLite hash cache for reconciliation context reduction'
    rationale: 'Hashing governed files and storing results in a local SQLite DB (.notarai/.cache/notarai.db) lets the reconcile command skip doc artifacts that have not changed since the last run, keeping context window usage proportional to actual change volume rather than the full repo'
  - date: '2026-02-24'
    choice: 'Synchronous JSON-RPC 2.0 over stdio for the MCP server (no tokio)'
    rationale: 'The MCP stdio transport is a simple request/response loop — no async I/O is needed. Synchronous BufRead line-by-line is sufficient and avoids pulling in a tokio runtime'
  - date: '2026-02-24'
    choice: 'rusqlite bundled feature for SQLite'
    rationale: 'Compiles SQLite from source as part of the crate, keeping the binary fully self-contained without requiring a system libsqlite3'

artifacts:
  code:
    - path: 'src/main.rs'
      role: 'CLI entry point — clap definition and command dispatch'
    - path: 'src/commands/*.rs'
      role: 'Command implementations (validate, init, hook_validate, cache, mcp)'
    - path: 'src/core/*.rs'
      role: 'Core library (schema embedding, YAML parsing, jsonschema validation, hash cache, MCP tool implementations)'
  configs:
    - path: 'Cargo.toml'
      role: 'Rust package manifest — dependencies, build metadata, and binary target'
    - path: 'notarai.spec.json'
      role: 'JSON Schema that spec files are validated against'
    - path: 'commands/notarai-reconcile.md'
      role: 'Bundled Claude Code slash command copied by init'
    - path: 'commands/notarai-bootstrap.md'
      role: 'Bundled Claude Code slash command for bootstrap interview, copied by init'
    - path: 'templates/claude-context.md'
      role: 'Bundled CLAUDE.md section template written by notarai init to target projects'
  tests:
    - path: 'tests/**/*.rs'
      role: 'Integration tests (assert_cmd CLI tests, tempdir-based init tests)'
